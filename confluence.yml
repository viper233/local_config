---
# desktop.yml
- hosts: desktop
  name: Setup the Database and install confluence
  become: True

#   vars_prompt:
#     - name: "confluence_db_password"
#       prompt: "Enter the confluence users db password"
#       private: yes
# 
#     - name: "mysql_root_db_pass"
#       prompt: "Enter the root mysql users password"
#       private: yes

  vars_files: 
    - secrets.yml

  vars:
    - confluence_baseurl: "https://www.atlassian.com/software/confluence/downloads/binary"
    - confluence_version: 5.9.8
    - confluence_group: confluence
    - confluence_user: confluence
    - confluence_db: confluencedb
    - confluence_db_user: confluence
    - confluence_db_user_pass: "{{ vault_confluence_db_user_pass }}"
    - confluence_install_dir: "/opt/atlassian/confluence-{{ confluence_version }}"
    - confluece_plugin_dir: "{{ confluence_install_dir }}/confluence/WEB-INF/lib/"
    - confluence_base_dir: "/opt/atlassian/confluence"
    - confluence_home_dir: "/var/lib/confluence_home"
    - confluence_data_dir: "/var/atlassian/application-data/confluence"
    - confluence_server_id: "BMQD-0B7X-WW2E-JT4K"
    - confluence_license_key: "AAABLQ0ODAoPeNptkMtOwzAQRff+CktsYOEqDoE+JEvQJIuWpAUSKAsk5FoTailxIz8q+vc4TYGCW
      Fgaee69c2bOCqfw3NWYBpiGk8vx5CrCcVLiMKDXKAEjtGyt3CoWb1VVO1AC8HkBegf64nWC0x2vH
      e8EKNZwKBJugXV2EgwJpUh444ALK3fArHbQfxSWawuaVbw2gHy49ZI057JmxkK7AXVjtVSyWTszE
      NsG/Uw6ScmkAGWg3Lew4A2weJnn6WM8u81Q3beeQZvOEyKfrSwo7jdIP1qp9yegIxKM0VK/cyVNP
      +MI8fYNgfqlZwmb5g8JCabDF7JahSmZl9EdKtIF849kIzqKIhqhI5mXZ7PkV+cAvnDNGvSyejKej
      xH6pf+f7N5pseEG/p72E0DRkkwwLAIURcDGhkTk1y3K9n5vGBoNgQCX9uICFCgzZB6P0nCf4BghX
      JNBoc43dCOfX02f3"
    - mysql_jdbc_download_url: "http://cdn.mysql.com/Downloads/Connector-J/mysql-connector-java-5.1.39.tar.gz"
    - mysql_jdbc_download_md5: "c8988d4fc6e44364a2f51efe5b5139c1"
    - mysql_databases:
        - name: "{{ confluence_db }}"
    - mysql_users:                              
        - name: "{{ confluence_db_user }}"
          password: "{{ confluence_db_user_pass }}"
          priv: "confluencedb.*:ALL"
          host: "localhost"

  roles:
#     - geerlingguy.java
    - geerlingguy.mysql

  tasks:
    - name: install Confluence required packages
      apt:
        name: "{{ item }}"
        state: "{{ package_state }}"
      with_items:
        - python-lxml
        - openjdk-8-jdk

    - name: set basic facts
      set_fact:
        download_url: "{{ confluence_baseurl }}/atlassian-confluence-{{ confluence_version }}-x64.bin"
        download_tmp: "{{ confluence_home_dir }}/atlassian-confluence-{{ confluence_version }}-x64.bin"

    - name: create application group
      group: 
        name: "{{ confluence_group }}"
        system: no
        state: present

    - name: create user
      user: 
        name: "{{ confluence_user }}"
        system: no
        createhome: no
        comment: "Atlassian Confluence"
        group: "{{ confluence_group }}"
        home: "{{ confluence_home_dir }}"
        shell: /bin/false
        state: present

    - name: print directories
      debug:
        var: "{{ item }}"
      with_items:
        - confluence_base_dir
        - confluence_home_dir
        - confluence_install_dir

    - name: create directories
      file:
        path: "{{ item.path }}"
        state: directory
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      with_items:
        - { path: "{{ confluence_base_dir }}",
            owner: 'root',
            group: 'root',
            mode: '0750' }
        - { path: "{{ confluence_home_dir }}",
            owner: "{{ confluence_user }}",
            group: "{{ confluence_group }}",
            mode: '0755' }
        - { path: "{{ confluence_install_dir }}",
            owner: 'root',
            group: 'root',
            mode: '0750' }

#     - name: Print the download variables
#       debug:
#         var: "{{ item }}"
#       with_items:
#         - download_url
#         - download_tmp

    - name: Pull down Confluence binary
      get_url:
        url: "{{ download_url }}"
        dest: "{{ download_tmp }}"
        validate_certs: no
        force: no

# https://confluence.atlassian.com/doc/installing-confluence-on-linux-143556824.html
# atlassian-confluence-X.Y.bin -q -varfile response.varfile
#
# This is where the database and licensing details are stored
#     - name: Confluence config file
#       template:
#         dest: /var/atlassian/application-data/confluence/confluence.cfg.xml
